<% if(!business){ %>
    <div class="alert alert-danger" role="alert">
        You have not entered your business details yet. Please enter your business details to continue.
    </div>
    <% } %>
        <div class="container mt-5">
            <h1 class="text-center">Manage Your Business</h1>

            <!-- Card with tabs for different sections -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="businessTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="details-tab" data-bs-toggle="tab" href="#details" role="tab"
                                aria-controls="details" aria-selected="true">Business Details</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="products-tab" data-bs-toggle="tab" href="#products" role="tab"
                                aria-controls="products" aria-selected="false">Update Contact Info</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="feedback-tab" data-bs-toggle="tab" href="#feedback" role="tab"
                                aria-controls="feedback" aria-selected="false">Reviews</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="hours-tab" data-bs-toggle="tab" href="#hours" role="tab"
                                aria-controls="hours" aria-selected="false">Business Hours</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="businessTabsContent">
                        <!-- Business Details Tab -->
                        <div class="tab-pane fade show active" id="details" role="tabpanel"
                            aria-labelledby="details-tab">
                            <h4>Business Information</h4>
                            <form id="updateBusinessForm">

                                <input type="hidden" id="businessId" value="<%= business.id %>">
                                <div class="mb-3">
                                    <label for="businessName" class="form-label">Business Name</label>
                                    <input type="text" class="form-control" id="businessName"
                                        placeholder="Enter business name" value=" <%= business.business_name %>">
                                </div>

                                <div class="mb-3">
                                    <label for="businessAddress" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="businessAddress"
                                        placeholder="Enter business address" value="<%= business.address %>">
                                </div>
                                <!-- <div class="mb-3">
                                    <label for="pincode" class="form-label">Pincode</label>
                                    <input type="number" class="form-control" id="pincode" placeholder="Enter Pincode"
                                        value="<%= business.pincode %>">
                                </div> -->
                                <!-- City -->
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="businessCity" name="city"
                                        value="<%= business.city %>" required>
                                </div>

                                <!-- State -->
                                <div class="mb-3">
                                    <label for="state" class="form-label">State</label>
                                    <input type="text" class="form-control" id="businessState" name="state"
                                        value="<%= business.state %>" required>
                                </div>
                                <!-- Category -->
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="businessCategory" name="category"
                                        value="<%= business.category %>" required>
                                </div>
                                <div class="mb-3">
                                    <label for="businessPhone" class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="businessPhone"
                                        placeholder="Enter business phone" value="<%= business.phone %>">
                                </div>

                                <!-- Website -->
                                <div class="mb-3">
                                    <label for="website" class="form-label">Website</label>
                                    <input type="text" class="form-control" id="businessWebsite"
                                        value="<%= business.website %>" name="website">
                                </div>


                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>

                        <!-- update email Tab -->
                        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                            <h4>Update Email</h4>

                            <div class="table-responsive">
                                <input type="email" class="form-control mb-3" placeholder="Enter updated email"
                                    value="<%= email %>" id="newEmail">
                            </div>
                            <button class="btn btn-success" onclick="updateEmail()">Send Otp</button>
                        </div>

                        <!-- Reviews Tab -->
                        <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
                            <h4>Customer Feedback</h4>
                            <div class="list-group">
                                <!-- Example Feedback -->
                                <a href="#" class="list-group-item list-group-item-action">
                                    <h5 class="mb-1">Customer Name</h5>
                                    <p class="mb-1">Great service, highly recommend!</p>
                                    <small>Rating: ★★★★☆</small>
                                </a>
                            </div>
                        </div>

                        <!-- hours Tab -->
                        <div class="tab-pane fade" id="hours" role="tabpanel" aria-labelledby="hours-tab">
                            <h4>Customer Feedback</h4>
                            <div class="list-group">
                                <!-- Example Feedback -->

                                <h2>Select Business Days</h2>

                                <form id="businessHoursForm">
                                    <label><input type="checkbox" name="days" value="Monday"> Monday</label>
                                    <label><input type="checkbox" name="days" value="Tuesday"> Tuesday</label>
                                    <label><input type="checkbox" name="days" value="Wednesday"> Wednesday</label>
                                    <label><input type="checkbox" name="days" value="Thursday"> Thursday</label>
                                    <label><input type="checkbox" name="days" value="Friday"> Friday</label>
                                    <label><input type="checkbox" name="days" value="Saturday"> Saturday</label>
                                    <label><input type="checkbox" name="days" value="Sunday"> Sunday</label>
                                    <input type="hidden" id="existing_hours"
                                        value="<%= businessHours.length > 0 ? 'true' : 'false' %>">


                                    <div class="time-input" id="timeSelection">
                                        <h3>Set Common Business Hours</h3>
                                        Open: <input type="time" id="opening_time">
                                        Close: <input type="time" id="closing_time">
                                    </div>


                                    <button type="submit">Save Schedule</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <script>
            // document.addEventListener("DOMContentLoaded", async () => {
            //     const businessId = "123";  // Replace with dynamic ID if necessary
            //     const response = await fetch(`/business-hours/${businessId}`);
            //     const businessHours = await response.json();

            //     // Pre-select checkboxes and set time
            //     businessHours.forEach(({ day_of_week, opening_time, closing_time }) => {
            //         const checkbox = document.querySelector(`input[value="${day_of_week}"]`);
            //         if (checkbox) {
            //             checkbox.checked = true;
            //         }
            //         document.getElementById("openingTime").value = opening_time;
            //         document.getElementById("closingTime").value = closing_time;
            //     });
            // });
            const checkboxes = document.querySelectorAll('input[name="days"]');
            const timeInputSection = document.getElementById("timeSelection");

            // Show time input only when at least one day is selected
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    timeInputSection.style.display = document.querySelector('input[name="days"]:checked') ? "block" : "none";
                });
            });





            document.getElementById("businessHoursForm").addEventListener("submit", function (event) {
                event.preventDefault();

                // Collect the form data
                const opening_time = document.getElementById("opening_time").value;
                const closing_time = document.getElementById("closing_time").value;

                // Define all the days
                const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                // Collect selected days from the checked checkboxes
                const selectedDays = [];
                document.querySelectorAll('input[name="days"]:checked').forEach(checkbox => {
                    selectedDays.push(checkbox.value);
                    console.log(selectedDays)
                });

                // Prepare the schedule with days and times
                const schedule = allDays.map(day => {
                    const isSelected = selectedDays.includes(day); // Check if the day is selected
                    return {
                        day: day,
                        openingTime: isSelected ? opening_time : "CLOSED", // If selected, use opening time
                        closingTime: isSelected ? closing_time : "CLOSED" // If selected, use closing time
                    };
                });

                // Prepare the formData object to send to the backend
                const formData = {
                    businessId: document.getElementById('businessId').value, // Add businessId to formData
                    schedule: schedule
                };

                // Check if we need to POST (insert) or PUT (update)
                const existingHoursValue = document.getElementById("existing_hours").value;
                const method = "POST"; // Use PUT for update, POST for new

                // Send the request to the backend
                fetch("/business-hours", {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData) // Send the formData as JSON
                })
                    .then(response => response.json())
                    .then(result => {
                        alert(result.message);
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            });
            function populateForm(response) {
                const businessHours = response.businessHours;  // Accessing the array from the response
                console.log(businessHours);  // Check if the array is correctly populated
                const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                businessHours.forEach(hour => {
                    const day = hour.day_of_week;
                    const openingTime = hour.opening_time;
                    const closingTime = hour.closing_time;

                    const checkbox = document.querySelector(`input[name="days"][value="${day}"]`);
                    if (checkbox) {
                        checkbox.checked = openingTime !== "00:00:00" && closingTime !== "00:00:00";
                    }

                    if (openingTime !== "00:00:00" && closingTime !== "00:00:00") {
                        document.getElementById("opening_time").value = openingTime;
                        document.getElementById("closing_time").value = closingTime;
                    }
                });
            }


            document.addEventListener("DOMContentLoaded", async () => {
                const businessId = document.getElementById("businessId").value;


                try {
                    const response = await fetch(`/business-hours/${businessId}`);
                    const businessHours = await response.json();


                    populateForm(businessHours);
                } catch (error) {
                    console.error("Error fetching business hours:", error);
                }
            });


        </script>